<!doctype html>
<html>

<head>
  <title>ESLab1 Chat Room</title>
  <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">
  <style>
    html {
      height: 100%;
      box-sizing: border-box;
    }

    *,
    *:before,
    *:after {
      box-sizing: inherit;
    }

    body {
      height: 100%;
      font: 13px 'Ubuntu', sans-serif;
      margin: 0;
      min-height: 100%;
      display: flex;
      flex-flow: row wrap;
      overflow: hidden;
    }

    form {
      bottom: 0;
      width: 100%;
    }

    form input {
      border: 0;
      padding: 10px;
      width: 80%;
    }

    form button {
      width: 19.75%;
      background: #2a87ff;
      color: #fff;
      border: none;
      padding: 10px;
    }

    #messages {
      list-style-type: none;
      margin: 0;
      padding: 0;
    }

    #messages li {
      box-sizing: border-box;
      height: 25px;
      padding: 5px 10px;
    }

    #container {
      display: flex;
      flex-direction: column;
      width: calc(100% - 200px);
    }

    #members {
      text-align: center;
    }

    .time {
      font-size: 6px;
      color: #8E8E8E;
    }

    header {
      background: #3b5998;
      color: #fff;
      text-align: center;
      height: 10%;
    }

    section {
      background: #f7f7f7;
      height: 200%;
      overflow-y: auto;
      border-bottom: 33px;
    }

    footer {
      height: 10%;
      background: #ffffff;
    }

    aside {
      background: #dfe3ee;
      flex: 1;
    }

    aside input {
      border: 0;
      padding: 10px;
      width: 100%;
    }

    #buttonNick {
      width: 50%;
      background: #639ff2;
      border: none;
      padding: 10px;
      color: #fff;
    }

    #buttonReg {
      width: 50%;
      background: #fff;
      border: none;
      padding: 10px;
      color: #639ff2;
    }
  </style>
</head>

<body>
  <div id="container">
    <header>
      <h2>Messages</h2>
    </header>
    <section id="msg_sec">
      <ul id="messages"></ul>
    </section>
    <footer>
      <form action="">
        <input id="boxMessage" type="text" autocomplete="off" disabled="true" placeholder="Type a messages..." />
        <button
          id="buttonMessage" disabled="true">Send</button>
      </form>
    </footer>
  </div>
  <aside>
    <h2 id="members">Members</h2>
    <input id="boxNick" type="text" placeholder="Username" size="13" />
    <input id="boxPass" type="password" placeholder="Password" size="13" />
    <button type="submit" id="buttonNick">Login</button><button type="submit" id="buttonReg" onClick="setMyName()">Register</button>
    <ul id="ulist"></ul>
  </aside>

  <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
  <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
  <script>
    const objDiv = document.getElementById('msg_sec');
    // const usersList = [];
    let userCred = { username: '', password: '' };
    var myNick = "";
    let imTyping = false;

    const socket = io();

    function setMyName() {
      userCred.username = document.getElementById('boxNick').value;
      userCred.password = document.getElementById('boxPass').value;
      myNick = userCred.username;
      const list = document.getElementById('ulist');
      for (let i = 0; i < list.childElementCount; i += 1) {
        if (userCred.username === list.children.item(i).innerHTML) {
          alert(`Username \"${userCred.username}\" is taken.`);
          return;
        }
      }
      socket.emit('set nick', userCred);

      // delete input and button after nickname is entered
      document.getElementById('boxNick').outerHTML = '';
      document.getElementById('boxPass').outerHTML = '';
      document.getElementById('buttonNick').outerHTML = '';
      document.getElementById('buttonReg').outerHTML = '';

      document.getElementById('boxMessage').disabled = false;
      document.getElementById('buttonMessage').disabled = false;
    }

    function updateUserList(u) {
      const list = document.getElementById('ulist');
      list.innerHTML = '';

      for (let i = 0; i < u.length; i += 1) {
        const item = document.createElement('li');
        if (u[i] === userCred.username) {
          item.innerHTML = `<b>${u[i]}</b> <i>(You)</i>`;
        } else {
          item.innerHTML = u[i];
        }
        list.appendChild(item);
      }
    }

    function dateTime() {
      const date = new Date();
      const year = date.getFullYear();
      const month = date.getMonth();
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October',
        'November', 'December'
      ];
      const d = date.getDate();
      const day = date.getDay();
      const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      let h = date.getHours();
      let m = date.getMinutes();
      let s = date.getSeconds();
      if (h < 10) {
        h = `0${h}`;
      }
      if (m < 10) {
        m = `0${m}`;
      }
      if (s < 10) {
        s = `0${s}`;
      }
      const result = `${days[day]} ${months[month]} ${d} ${year} ${h}:${m}:${s}`;
      return result;
    }

    socket.on('connect', () => {
      socket.emit('start');
    });

    socket.on('nick', (nick) => {
      //console.log("into nick: " + nick);
      myNick = nick;
    });

    $('form').submit(() => {
      const temp = [dateTime(), myNick, $('#boxMessage').val()];
      socket.emit('send chat message', temp);
      $('#boxMessage').val('');
      imTyping = false;
      socket.emit('not typing');
      return false;
    });

    socket.on('chat message', (msg) => {
      //console.log("myNick = " + myNick + ", msg[1] = " + msg[1]);
      if (msg[1] === myNick) {
        $('#messages').append(`<li><p align='right'>${msg[2]}</p></br></li>`);
        $('#messages').append(`<li><p class='time' align='right'>${msg[0]}</p></li>`);
      } else {
        $('#messages').append(`<li><b><p align='left'>${msg[1]}:</b> ${msg[2]}</p></li>`);
        $('#messages').append(`<li><p class='time' align='left'>${msg[0]}</p></li>`);
      }
      objDiv.scrollTop = objDiv.scrollHeight;
    });

    socket.on('info', (inf) => {
      $('#messages').append(`<li class='inf'><i>${inf}</i></li>`);
    });

    socket.on('users list', (usersList) => {
      updateUserList(usersList);
    });

    socket.on('typing signal', (usersList) => {
      updateUserList(usersList);
    });

    $('#boxMessage').on('input', () => {
      if ($('#boxMessage').val() !== '' && imTyping === false) {
        socket.emit('typing');
        imTyping = true;
      } else if ($('#boxMessage').val() === '') {
        socket.emit('not typing');
        imTyping = false;
      }
    });
  </script>
</body>

</html>